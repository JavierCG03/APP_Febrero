<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CarslineApp.Views.Buscador.ClientesPage"
             x:Name="RootPage"
             Title="Clientes"
             NavigationPage.HasBackButton="True"
             NavigationPage.HasNavigationBar="True"
             BackgroundColor="#F8F9FA">

    <Grid RowDefinitions="*,Auto">

        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- HEADER CLIENTE -->
                <Frame BackgroundColor="White"
                       Padding="20"
                       CornerRadius="15"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">

                        <!-- Placas (Modo Normal) -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Spacing="2" Grid.Column="0">
                                <Label Text="{Binding Cliente.NombreCompleto}"
                                      FontSize="22"
                                      FontAttributes="Bold"
                                      TextColor="#1A1A1A"/>
                                <Label Text="Cliente"
                                       FontSize="14"
                                       TextColor="#666"/>
                            </VerticalStackLayout>

                            <ImageButton Grid.Column="1"
                                        Command="{Binding EditarClienteCommand}"
                                        IsVisible="{Binding MostrarBotonEditar}"
                                        Source="editar.png"
                                        BackgroundColor="Transparent"
                                        WidthRequest="40"
                                        HeightRequest="40"/>
                        </Grid>

                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- INFORMACIÃ“N PERSONAL -->
                        <VerticalStackLayout Spacing="15">
                            <Label Text="ðŸ“‹ INFORMACIÃ“N PERSONAL"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#B00000"/>

                            <!-- RFC -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="RFC"
                                       FontSize="12"
                                       TextColor="#666"/>
                                <Entry Text="{Binding RFC}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>
                            </VerticalStackLayout>

                            <!-- TelÃ©fono MÃ³vil con accesos directos -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="TelÃ©fono MÃ³vil *"
                                       FontSize="12"
                                       TextColor="#666"/>

                                <!-- Modo EdiciÃ³n -->
                                <Entry Text="{Binding TelefonoMovil}"
                                       IsVisible="{Binding ModoEdicion}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       Keyboard="Telephone"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>

                                <!-- Modo Vista con Accesos Directos -->
                                <Grid ColumnDefinitions="*,Auto,Auto" 
                                      ColumnSpacing="10"
                                      IsVisible="{Binding CamposBloqueados}">
                                    <Label Grid.Column="0"
                                           Text="{Binding TelefonoMovil}"
                                           FontSize="16"
                                           TextColor="#2C3E50"
                                           VerticalOptions="Center"/>
                                    <ImageButton Grid.Column="1"
                                                    Source="whatsapp.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="45"
                                                 WidthRequest="45"
                                                 Command="{Binding AbrirWhatsAppCommand}" 
                                                 CommandParameter="{Binding TelefonoMovil}"/>
                                    
                                    <ImageButton Grid.Column="2"
                                                 Source="llamar.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="45"
                                                 WidthRequest="45"
                                                 Command="{Binding LlamarTelefonoCommand}" 
                                                 CommandParameter="{Binding TelefonoMovil}"/>

                                </Grid>
                            </VerticalStackLayout>

                            <!-- TelÃ©fono Casa con acceso directo -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="TelÃ©fono Casa"
                                       FontSize="12"
                                       TextColor="#666"/>

                                <!-- Modo EdiciÃ³n -->
                                <Entry Text="{Binding TelefonoCasa}"
                                       IsVisible="{Binding ModoEdicion}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       Keyboard="Telephone"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>

                                <!-- Modo Vista con Acceso Directo -->
                                <Grid ColumnDefinitions="*,Auto" 
                                      ColumnSpacing="10"
                                      IsVisible="{Binding CamposBloqueados}">
                                    <Label Grid.Column="0"
                                           Text="{Binding TelefonoCasa}"
                                           FontSize="16"
                                           TextColor="#2C3E50"
                                           VerticalOptions="Center"/>
                                    
                                    <ImageButton Grid.Column="1"
                                                 Source="llamar.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="45"
                                                 WidthRequest="45"
                                                 Command="{Binding LlamarTelefonoCommand}" 
                                                 CommandParameter="{Binding TelefonoCasa}"/>

                                </Grid>
                            </VerticalStackLayout>

                            <!-- Correo ElectrÃ³nico con acceso directo -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Correo ElectrÃ³nico"
                                       FontSize="12"
                                       TextColor="#666"/>

                                <!-- Modo EdiciÃ³n -->
                                <Entry Text="{Binding CorreoElectronico}"
                                       IsVisible="{Binding ModoEdicion}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       Keyboard="Email"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>

                                <!-- Modo Vista con Acceso Directo -->
                                <Grid ColumnDefinitions="*,Auto" 
                                      ColumnSpacing="10"
                                      IsVisible="{Binding CamposBloqueados}">
                                    <Label Grid.Column="0"
                                           Text="{Binding CorreoElectronico}"
                                           FontSize="16"
                                           TextColor="#2C3E50"
                                           VerticalOptions="Center"
                                           LineBreakMode="TailTruncation"/>

                                    <ImageButton Grid.Column="1"
                                                 Source="correo.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="45"
                                                 WidthRequest="45"
                                                 Command="{Binding EnviarEmailCommand}" 
                                                 CommandParameter="{Binding CorreoElectronico}"/>
                                </Grid>
                            </VerticalStackLayout>
                        </VerticalStackLayout>

                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- DIRECCIÃ“N -->
                        <VerticalStackLayout Spacing="15">

                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                     Text= "ðŸ“ DIRECCIÃ“N"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#B00000"/>

                                <ImageButton Grid.Column="1"
                                                 Source="ubicacion.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="45"
                                                 WidthRequest="45"
                                                 Command="{Binding AbrirMapaCommand}"
                                                  IsVisible="{Binding CamposBloqueados}"/>
                            </Grid>

                            <!-- Calle y NÃºmero -->
                            <Grid ColumnDefinitions="2*,*" ColumnSpacing="10">
                                <VerticalStackLayout Grid.Column="0" Spacing="5">
                                    <Label Text="Calle"
                                           FontSize="12"
                                           TextColor="#666"/>
                                    <Entry Text="{Binding Calle}"
                                           IsEnabled="{Binding ModoEdicion}"
                                           FontSize="14"
                                           BackgroundColor="#F8F9FA"
                                           TextColor="#1A1A1A"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="No. Ext"
                                           FontSize="12"
                                           TextColor="#666"/>
                                    <Entry Text="{Binding NumeroExterior}"
                                           IsEnabled="{Binding ModoEdicion}"
                                           FontSize="14"
                                           BackgroundColor="#F8F9FA"
                                           TextColor="#1A1A1A"/>
                                </VerticalStackLayout>
                            </Grid>

                            <!-- Colonia -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Colonia"
                                       FontSize="12"
                                       TextColor="#666"/>
                                <Entry Text="{Binding Colonia}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>
                            </VerticalStackLayout>

                            <!-- Municipio y CP -->
                            <Grid ColumnDefinitions="2*,*" ColumnSpacing="10">
                                <VerticalStackLayout Grid.Column="0" Spacing="5">
                                    <Label Text="Municipio"
                                           FontSize="12"
                                           TextColor="#666"/>
                                    <Entry Text="{Binding Municipio}"
                                           IsEnabled="{Binding ModoEdicion}"
                                           FontSize="14"
                                           BackgroundColor="#F8F9FA"
                                           TextColor="#1A1A1A"/>
                                </VerticalStackLayout>

                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="CP"
                                           FontSize="12"
                                           TextColor="#666"/>
                                    <Entry Text="{Binding CodigoPostal}"
                                           IsEnabled="{Binding ModoEdicion}"
                                           Keyboard="Numeric"
                                           FontSize="14"
                                           BackgroundColor="#F8F9FA"
                                           TextColor="#1A1A1A"/>
                                </VerticalStackLayout>
                            </Grid>

                            <!-- Estado -->
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Estado"
                                       FontSize="12"
                                       TextColor="#666"/>
                                <Entry Text="{Binding Estado}"
                                       IsEnabled="{Binding ModoEdicion}"
                                       FontSize="14"
                                       BackgroundColor="#F8F9FA"
                                       TextColor="#1A1A1A"/>
                            </VerticalStackLayout>

                        </VerticalStackLayout>

                        <!-- Botones de EdiciÃ³n -->
                        <Grid ColumnDefinitions="*,*"
                              ColumnSpacing="10"
                              IsVisible="{Binding MostrarBotonesEdicion}">
                            <Button Grid.Column="0"
                                   Text="ðŸ’¾ Guardar"
                                   Command="{Binding GuardarCambiosCommand}"
                                   BackgroundColor="#4CAF50"
                                   TextColor="White"
                                   CornerRadius="8"/>
                            <Button Grid.Column="1"
                                   Text="âŒ Cancelar"
                                   Command="{Binding CancelarEdicionCommand}"
                                   BackgroundColor="#757575"
                                   TextColor="White"
                                   CornerRadius="8"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- VEHÃCULOS DEL CLIENTE -->
                <Frame BackgroundColor="White"
                       Padding="20"
                       CornerRadius="15"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸš— VEHÃCULOS"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A"/>

                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- Lista de VehÃ­culos -->
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding VehiculosCliente}"
                                            Spacing="10">
                            <BindableLayout.EmptyView>
                                <Label Text="ðŸ“­ No hay vehÃ­culos registrados para este cliente"
                                       TextColor="#999"
                                       FontSize="14"
                                       HorizontalOptions="Center"
                                       Margin="0,20"/>
                            </BindableLayout.EmptyView>

                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="#F8F9FA"
                                           Padding="15"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           BorderColor="#E9ECEF">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.VerVehiculoCommand}"
                                                CommandParameter="{Binding Id}"/>
                                        </Frame.GestureRecognizers>

                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">


                                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                                <Label Text="{Binding VehiculoCompleto}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="#1A1A1A"/>
                                                <Label FontSize="12"
                                                       TextColor="#666">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="Placas: "/>
                                                            <Span Text="{Binding Placas}"
                                                                  FontAttributes="Bold"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                                <Label FontSize="11"
                                                       TextColor="#999">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="VIN: ..."/>
                                                            <Span Text="{Binding Ultimos4VIN}"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </VerticalStackLayout>

                                            <Label Grid.Column="2"
                                                   Text="â†’"
                                                   FontSize="30"
                                                   TextColor="#2196F3"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Overlay -->
        <Frame Grid.Row="0"
               IsVisible="{Binding IsLoading}"
               BackgroundColor="#80000000"
               Padding="40"
               CornerRadius="20"
               HorizontalOptions="Center"
               VerticalOptions="Center">
            <VerticalStackLayout Spacing="15">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="White"
                                   WidthRequest="50"
                                   HeightRequest="50"/>
                <Label Text="Cargando..."
                       TextColor="White"
                       FontSize="16"
                       FontAttributes="Bold"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Error Message -->
        <Frame Grid.Row="1"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
               BackgroundColor="#FFF3CD"
               BorderColor="#FFC107"
               Padding="15"
               Margin="20,0,20,20"
               CornerRadius="10">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="#856404"
                   FontSize="14"/>
        </Frame>
    </Grid>
</ContentPage>
