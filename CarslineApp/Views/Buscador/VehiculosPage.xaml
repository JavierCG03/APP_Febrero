<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CarslineApp.Views.Buscador.VehiculosPage"
             x:Name="RootPage"
             Title="Vehiculos "
             NavigationPage.HasBackButton="True"
             NavigationPage.HasNavigationBar="True"
             BackgroundColor="#F8F9FA">

    <Grid RowDefinitions="*,Auto">

        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- HEADER VEHÃCULO -->
                <Frame BackgroundColor="White"
                       Padding="20"
                       CornerRadius="15"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">
                        
                        <Label Text="{Binding Vehiculo.VehiculoCompleto}"
                                       FontSize="22"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A"/>


                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- VIN con acciones -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="VIN (NÃºmero de Serie):"
                                   FontSize="12"
                                   TextColor="#666"/>

                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0"
                                       Text="{Binding Vehiculo.VIN}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A"
                                       VerticalOptions="Center">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding CopiarVINCommand}" />
                                    </Label.GestureRecognizers>
                                </Label>

                                <ImageButton Grid.Column="1"
                                                 Source="buscar.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="35"
                                                 WidthRequest="35"
                                                 Command="{Binding ConsultarREPUVEPorVINCommand}"/>

                            </Grid>
                        </VerticalStackLayout>

                        <!-- Placas (Modo Normal) -->
                        <VerticalStackLayout Spacing="5" IsVisible="{Binding MostrarPlacasNormales}">
                            <Label Text="Placas:"
                                   FontSize="12"
                                   TextColor="#666"/>

                            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">

                                <Label Grid.Column="0"
                                       Text="{Binding Vehiculo.Placas}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A"
                                       VerticalOptions="Center">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding CopiarPlacasCommand}"/>
                                    </Label.GestureRecognizers>
                                </Label>

                                <ImageButton Grid.Column="1"
                                                 Source="editar.png"
                                                 BackgroundColor="Transparent"
                                                 HeightRequest="35"
                                                 WidthRequest="35"
                                                 Command="{Binding EditarPlacasCommand}"/>

                            </Grid>
                        </VerticalStackLayout>

                        <!-- Placas (Modo EdiciÃ³n) -->
                        <VerticalStackLayout Spacing="10"
                                            IsVisible="{Binding MostrarEdicionPlacas}">
                            <Label Text="Placas:"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#B00000"/>
                            <Entry Text="{Binding NuevasPlacas}"
                                   Placeholder="Ingresa las nuevas placas"
                                   FontSize="14"
                                   BackgroundColor="#F8F9FA"
                                   TextColor="#1A1A1A"/>
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                <Button Grid.Column="0"
                                       Text="ðŸ’¾ Guardar"
                                       Command="{Binding GuardarPlacasCommand}"
                                       BackgroundColor="#4CAF50"
                                       TextColor="White"
                                       CornerRadius="8"/>
                                <Button Grid.Column="1"
                                       Text="âŒ Cancelar"
                                       Command="{Binding CancelarEdicionCommand}"
                                       BackgroundColor="#757575"
                                       TextColor="White"
                                       CornerRadius="8"/>
                            </Grid>
                        </VerticalStackLayout>


                        <!-- AÃ±o y VersiÃ³n -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="20" RowSpacing="10">
                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                <Label Text="AÃ±o:"
                                       FontSize="12"
                                       TextColor="#666"/>
                                <Label Text="{Binding Vehiculo.Anio}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                <Label Text="VersiÃ³n:"
                                       FontSize="12"
                                       TextColor="#666"/>
                                <Label Text="{Binding Vehiculo.Version}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A"/>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Kilometraje Inicial -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Kilometraje Inicial:"
                                   FontSize="12"
                                   TextColor="#666"/>
                            <Label FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding Vehiculo.KilometrajeInicial, StringFormat='{0:N0}'}"/>
                                        <Span Text=" km"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- PROPIETARIO -->
                <Frame BackgroundColor="White"
                       Padding="20"
                       CornerRadius="15"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ‘¤ PROPIETARIO"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A"/>

                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- Tarjeta Cliente con Acciones RÃ¡pidas -->
                        <Frame BackgroundColor="#F8F9FA"
                               Padding="15"
                               CornerRadius="10"
                               HasShadow="False"
                               BorderColor="#E9ECEF">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding VerClienteCommand}"/>
                            </Frame.GestureRecognizers>

                            <VerticalStackLayout Spacing="15">
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">
                                    <VerticalStackLayout Grid.Column="0" Spacing="10">
                                        
                                        <Label Grid.Column="1"
                                               Text="{Binding Cliente.NombreCompleto}"
                                                   VerticalOptions="End"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#1A1A1A"/>

                                        <Label FontSize="13" TextColor="#666">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="ðŸ“ž "/>
                                                    <Span Text="{Binding Cliente.TelefonoMovil}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <Label FontSize="13" TextColor="#666">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="ðŸ†” "/>
                                                    <Span Text="{Binding Cliente.RFC}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>

                                    <Label Grid.Column="1"
                                           Text="â†’"
                                           FontSize="24"
                                           TextColor="#B00000"
                                           VerticalOptions="Center"/>
                                </Grid>

                            </VerticalStackLayout>
                        </Frame>

                    </VerticalStackLayout>
                </Frame>

                <!-- HISTORIAL DE Ã“RDENES -->
                <Frame BackgroundColor="White"
                       Padding="20"
                       CornerRadius="15"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="ðŸ“‹ HISTORIAL DE Ã“RDENES"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A"/>

                        <BoxView HeightRequest="2" BackgroundColor="#E9ECEF"/>

                        <!-- Lista de Ã“rdenes -->
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding OrdenesVehiculo}"
                                            Spacing="10">
                            <BindableLayout.EmptyView>
                                <Label Text="ðŸ“­ No hay Ã³rdenes registradas para este vehÃ­culo"
                                       TextColor="#999"
                                       FontSize="14"
                                       HorizontalOptions="Center"
                                       Margin="0,20"/>
                            </BindableLayout.EmptyView>

                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="#F8F9FA"
                                           Padding="15"
                                           CornerRadius="10"
                                           HasShadow="False"
                                           BorderColor="#E9ECEF">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.VerOrdenCommand}"
                                                CommandParameter="{Binding Id}"/>
                                        </Frame.GestureRecognizers>

                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                            <Frame Grid.Column="0"
                                                   BackgroundColor="#B00000"
                                                   Padding="10"
                                                   CornerRadius="8"
                                                   HasShadow="False"
                                                   WidthRequest="50"
                                                   HeightRequest="50">
                                                <Label Text="ðŸ“‹"
                                                       FontSize="24"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Frame>

                                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                                <Label Text="{Binding NumeroOrden}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="#1A1A1A"/>
                                                <Label FontSize="12"
                                                       TextColor="#666">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="ðŸ“… "/>
                                                            <Span Text="{Binding FechaCreacion, StringFormat='{0:dd/MMM/yyyy}'}"/>
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                                <Frame BackgroundColor="#4CAF50"
                                                       Padding="6,3"
                                                       CornerRadius="4"
                                                       HasShadow="False"
                                                       HorizontalOptions="Start">
                                                    <Label Text="{Binding EstadoOrden}"
                                                           FontSize="10"
                                                           FontAttributes="Bold"
                                                           TextColor="White"/>
                                                </Frame>
                                            </VerticalStackLayout>

                                            <Label Grid.Column="2"
                                                   Text="â†’"
                                                   FontSize="20"
                                                   TextColor="#B00000"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Overlay -->
        <Frame Grid.Row="0"
               IsVisible="{Binding IsLoading}"
               BackgroundColor="#80000000"
               Padding="40"
               CornerRadius="20"
               HorizontalOptions="Center"
               VerticalOptions="Center">
            <VerticalStackLayout Spacing="15">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="White"
                                   WidthRequest="50"
                                   HeightRequest="50"/>
                <Label Text="Cargando..."
                       TextColor="White"
                       FontSize="16"
                       FontAttributes="Bold"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Error Message -->
        <Frame Grid.Row="1"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
               BackgroundColor="#FFF3CD"
               BorderColor="#FFC107"
               Padding="15"
               Margin="20,0,20,20"
               CornerRadius="10">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="#856404"
                   FontSize="14"/>
        </Frame>
    </Grid>
</ContentPage>
